{% extends 'base/base.html' %}

{% block title %}My List - AIFLIX{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-3">My List</h1>
            <p class="text-muted">
                {% if total_items > 0 %}
                    {{ total_items }} item{{ total_items|pluralize }} in your list
                {% else %}
                    Your list is empty. Add movies and TV shows to watch later.
                {% endif %}
            </p>
        </div>
    </div>

    {% if movies %}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="section-title mb-4">Movies</h2>
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4">
                {% for movie in movies %}
                <div class="col">
                    <div class="movie-card h-100">
                        <a href="{% url 'movies:movie_detail' movie.id movie.slug %}" class="text-decoration-none">
                            <div class="position-relative">
                                <img src="{{ movie.thumbnail.url }}" class="img-fluid rounded" alt="{{ movie.title }}">
                                <div class="movie-card-overlay">
                                    <div class="movie-card-info">
                                        <h6>{{ movie.title }}</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-danger">{{ movie.get_maturity_rating_display }}</span>
                                            <span class="text-warning">
                                                <i class="fas fa-star"></i> {{ movie.imdb_rating|default:"N/A" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-light toggle-my-list" data-movie-id="{{ movie.id }}" data-in-list="true">
                                <i class="fas fa-check me-1"></i> In My List
                            </button>
                            <a href="{% url 'movies:watch' movie.id movie.slug %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-play"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if series %}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="section-title mb-4">TV Shows</h2>
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4">
                {% for show in series %}
                <div class="col">
                    <div class="movie-card h-100">
                        <a href="{% url 'movies:movie_detail' show.id show.slug %}" class="text-decoration-none">
                            <div class="position-relative">
                                <img src="{{ show.thumbnail.url }}" class="img-fluid rounded" alt="{{ show.title }}">
                                <div class="movie-card-overlay">
                                    <div class="movie-card-info">
                                        <h6>{{ show.title }}</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-danger">{{ show.get_maturity_rating_display }}</span>
                                            <span class="text-warning">
                                                <i class="fas fa-star"></i> {{ show.imdb_rating|default:"N/A" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-light toggle-my-list" data-movie-id="{{ show.id }}" data-in-list="true">
                                <i class="fas fa-check me-1"></i> In My List
                            </button>
                            <a href="{% url 'movies:watch' show.id show.slug %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-play"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if not movies and not series %}
    <div class="row justify-content-center text-center py-5 my-5">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="empty-state">
                <i class="fas fa-bookmark fa-4x text-muted mb-4"></i>
                <h3 class="h4">Your list is empty</h3>
                <p class="text-muted mb-4">
                    Add movies and TV shows to your list to watch them later.
                </p>
                <a href="{% url 'movies:home' %}" class="btn btn-danger">
                    <i class="fas fa-play me-2"></i> Browse Content
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.section-title {
    position: relative;
    padding-bottom: 10px;
    font-size: 1.5rem;
    font-weight: 500;
}

.section-title:after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 50px;
    height: 3px;
    background-color: #e50914;
}

.movie-card {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    transition: transform 0.3s ease;
}

.movie-card:hover {
    transform: scale(1.03);
    z-index: 10;
}

.movie-card img {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
}

.movie-card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 1rem;
}

.movie-card:hover .movie-card-overlay {
    opacity: 1;
}

.movie-card-info {
    transform: translateY(20px);
    transition: transform 0.3s ease;
}

.movie-card:hover .movie-card-info {
    transform: translateY(0);
}

.movie-card-info h6 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.empty-state {
    padding: 3rem 0;
}

.empty-state i {
    opacity: 0.5;
    margin-bottom: 1.5rem;
}

.btn-outline-light {
    border-color: #4d4d4d;
    color: #b3b3b3;
}

.btn-outline-light:hover, .btn-outline-light:focus {
    background-color: transparent;
    border-color: #e50914;
    color: #fff;
}

.btn-outline-light.toggled {
    background-color: #e50914;
    border-color: #e50914;
    color: #fff;
}

.btn-danger {
    background-color: #e50914;
    border-color: #e50914;
}

.btn-danger:hover, .btn-danger:focus {
    background-color: #f40612;
    border-color: #f40612;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .section-title {
        font-size: 1.25rem;
    }
    
    .movie-card-info h6 {
        font-size: 0.8rem;
    }
    
    .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle My List functionality
    document.querySelectorAll('.toggle-my-list').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const movieId = this.dataset.movieId;
            const isInList = this.dataset.inList === 'true';
            const url = `/profiles/toggle-my-list/${movieId}/`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'removed') {
                    this.innerHTML = '<i class="far fa-plus me-1"></i> Add to List';
                    this.classList.remove('btn-outline-light');
                    this.classList.add('btn-outline-secondary');
                    this.dataset.inList = 'false';
                    
                    // If we're on the My List page, remove the item from the DOM
                    if (window.location.pathname.includes('my-list')) {
                        const movieCard = this.closest('.col');
                        if (movieCard) {
                            movieCard.style.opacity = '0.5';
                            setTimeout(() => {
                                movieCard.remove();
                                
                                // Check if we should show the empty state
                                const remainingItems = document.querySelectorAll('.movie-card').length;
                                if (remainingItems === 0) {
                                    window.location.reload();
                                }
                            }, 300);
                        }
                    }
                } else if (data.status === 'added') {
                    this.innerHTML = '<i class="fas fa-check me-1"></i> In My List';
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-outline-light');
                    this.dataset.inList = 'true';
                }
                
                // Show toast notification
                const toast = new bootstrap.Toast(document.getElementById('toast'));
                document.getElementById('toast-message').textContent = data.message;
                toast.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
